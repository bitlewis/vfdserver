<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Doto:wght@400..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Doto:wght@100..900&display=swap" rel="stylesheet">
    <title>VFD Control</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f7fc; color: #222; }
        .container { position: relative; width: 100%; }
        .header { width: 100%; background-color: #f4f7fc; text-align: center; }
        h1 { text-align: center; color: #333; font-size: 42px; font-family:"Doto", serif; font-optical-sizing: auto; font-style: normal; font-weight: 700; }
        .group { margin-bottom: 10px; }
        .group-title-container { display: flex; align-items: center; }
        .group-title { width: 80%; cursor: pointer; font-size: 18px; font-family:"Doto", serif; font-optical-sizing: auto; font-style: normal; font-weight: 700; background: #4CAF50; color: white; border-radius: 5px; padding: 10px; border: 1px solid #4CAF50; }
        .drive-list { display: none; padding-left: 15px; }
        .drive-item { padding: 5px; background: #fff; margin: 5px 0; border-radius: 5px; display: flex; align-items: center; }
        input[type="checkbox"] { margin-right: 10px; }
        .status-box { padding: 4px; border-radius: 4px; display: inline-block; cursor: not-allowed; border: 1px solid #007bff; }
        .grey { background-color: #d3d3d3; color: #555; }
        .blue { background-color: #007bff; color: white; }
        .green { background-color: #4CAF50; color: white; }
        .orange { background-color: #ffa500; color: white; }
        .inform { background-color: #eaeaea; color: rgb(0, 0, 0); }
        .totalcfm { font-family: Arial, sans-serif; font-size: 14px;background-color: #007bff; color: white; }
        .stale-data { background-color: #d3d3d3; }
        .control-panel { background-color: #fff; margin: 40px 40px 0 40px; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); position: sticky; top: 0; width: 95.55%; z-index: 10; }
        .control-panel button { font-size: 16px; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
        .control-panel button.fanhold { background-color: #f44336; color: white; }
        .control-panel button.set-speed { background-color: #4CAF50; color: white; }
        .control-panel button.start { background-color: #4CAF50; color: white; }
        .control-panel button.stop { background-color: #ffa500; color: white; }
        .control-panel input[type="number"] { padding: 10px; border: 1px solid #999999; border-radius: 5px; width: 100px; }
        .quickbutton { font-size: 14px; padding: 5px 5px; border: none; border-radius: 5px; cursor: pointer; }
        .drives-box { padding-top: 5px; width: 100%; margin: 5px auto; width: 97%;}
        .drives-panel { float: left; width: 83%; padding-bottom: 20px; }
        .control-events-panel { float: right; width: 15%; background-color: #fff; padding: 20px; overflow-y: auto; border-radius: 5px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); }
        @media (max-width: 768px) { .control-events-panel { position: static; width: 100%; height: auto; border-left: none; border-top: 1px solid #ddd; } }
        .control-events-panel h2 { margin-top: 0; font-size: 25px; font-family:"Doto", serif; font-optical-sizing: auto; font-style: normal; font-weight: 700; }
        .control-event { padding: 10px; border-bottom: 1px solid #ddd; }
        .control-event:last-child { border-bottom: none; }
        .event-box { padding: 4px; border-radius: 4px; font-size: 12px; display: inline-block; cursor: not-allowed; }
        .devices-box { padding: 4px; border-radius: 4px; font-size: 10px; display: inline-block; cursor: not-allowed; }
        .timestamp { font-size: 14px; display:inline-block; border-bottom:2px solid black; margin-bottom: 2px; }
        .control-button-title { font-size: 20px; font-family:"Doto", serif; font-optical-sizing: auto; font-style: normal; font-weight: 700; margin-bottom: 10px; }
        .fan-buttons { float: left; }
        .speed-legend { font-size: 14px; font-family:"Doto", serif; font-optical-sizing: auto; font-style: normal; font-weight: 500; }
        .drive-item { display: flex; align-items: center; justify-content: space-between; }
        .dark-mode body, .dark-mode { background-color: #181a1b !important; color: #eee !important; }
        .dark-mode .header { background-color: #181a1b !important; }
        .dark-mode h1 { color: #fff !important; }
        .dark-mode .group-title { background: #2d333b !important; color: #fff !important; border: 1px solid #444 !important; }
        .dark-mode .control-panel { background-color: #23272a !important; color: #eee !important; }
        .dark-mode .drive-item { background: #23272a !important; color: #eee !important; }
        .dark-mode .control-events-panel { background-color: #23272a !important; color: #eee !important; }
        .dark-mode .status-box.blue, .dark-mode .status-box.inform, .dark-mode .status-box.grey, .dark-mode .status-box.totalcfm { background-color: #3b4252 !important; color: #fff !important; }
        .dark-mode .status-box { color: #fff !important; border: 1px solid #444 !important; }
        .dark-mode .green { background-color: #4CAF50; color: white; }
        .dark-mode .orange { background-color: #ffa500; color: white; }
        .dark-mode input, .dark-mode select { background: #23272a !important; color: #eee !important; border-color: #444 !important; }
        .dark-mode .select-all, .dark-mode .drive-checkbox { accent-color: #388e3c; }
        .dark-mode .fanhold, .dark-mode .restart, .dark-mode .stop, .dark-mode .set-speed { color: #fff !important; }
        .dark-mode .fanhold { background-color: #b71c1c !important; }
        .dark-mode .restart { background-color: #388e3c !important; }
        .dark-mode .stop { background-color: #b71c1c !important; }
        .dark-mode .set-speed { background-color: #388e3c !important; }
        .dark-mode .timestamp { color: #fff !important; border-bottom:2px solid #888; }
        .dark-mode .group { background: none !important; }
        .dark-mode .drives-panel { background: none !important; }
        .dark-mode .drives-box { background: none !important; }
        .dark-mode .stale-data { background-color: #333 !important; }
        .dark-mode .control-event { border-bottom: 1px solid #444 !important; }
        .dark-mode .control-events-panel h2 { color: #fff !important; }
        .dark-mode .group-title { border: 1px solid #444 !important; }
        .dark-mode .status-box.red { background-color: #b71c1c !important; }
        .dark-mode .status-box.green { background-color: #388e3c !important; }
        .dark-mode .status-box.blue { background-color: #1976d2 !important; }
        .dark-mode .status-box.grey { background-color: #444 !important; }
        .dark-mode .status-box.totalcfm { background-color: #1976d2 !important; }
        .dark-mode .status-box.inform { background-color: #444 !important; }
        .dark-mode .status-box { border: 1px solid #444 !important; }
        .dark-mode .select-all { accent-color: #388e3c; }
        .dark-mode .drive-checkbox { accent-color: #388e3c; }
        html, body {
            /* height: 100%; */
        }
        .container {
            /* min-height: 100vh; */
        }
        .modal, #apiModal {
          /* Ensure modal overlay is always the same */
        }
        #apiModal .modal-content, #apiModal > div {
          color: #111 !important;
        }
        #apiModal, #apiModal * {
          color: #111 !important;
        }
        /* Prevent dark mode from affecting modal */
        .dark-mode #apiModal, .dark-mode #apiModal * {
          color: #111 !important;
        }
    </style>
    <script>
        // === 1. Config and Global Variables ===
        let siteName = "VFD Control";
        let groupLabel = "Group";
        let bindIP = "127.0.0.1:80";
        let expandedGroups = JSON.parse(localStorage.getItem("expandedGroups")) || {};
        if (Object.keys(expandedGroups).length === 0) {
            expandedGroups = new Proxy({}, { get: () => true }); // Default all GROUPs to expanded
        }
        let controlEvents = [];

        // === 2. App Config and WebSocket Setup ===
        fetch('/app-config')
            .then(r => r.json())
            .then(cfg => {
                if (cfg.siteName) siteName = cfg.siteName;
                if (cfg.groupLabel) groupLabel = cfg.groupLabel;
                document.title = siteName + " VFD Control";
                document.querySelector('h1').textContent = siteName + " VFD Control Panel";
                if (cfg.bindIP) bindIP = cfg.bindIP;
                const wsProto = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
                let wsHost = bindIP.includes(':') ? bindIP : (bindIP + ':80');
                const ws = new WebSocket(wsProto + wsHost + '/ws');
                ws.onmessage = function (event) {
                    const data = JSON.parse(event.data);
                    updateUI(data);
                };
                ws.onerror = function (e) { console.error('WebSocket error:', e); };
                ws.onclose = function () { console.warn('WebSocket closed'); };
            });

        // === 3. UI Update Functions ===
        function updateUI(data) {
            const container = document.getElementById('drive-container');
            const currentCheckboxStates = {};
            document.querySelectorAll(".drive-checkbox").forEach(cb => {
                currentCheckboxStates[cb.dataset.ip] = cb.checked;
            });
            let groups = {};
            data.forEach(drive => {
                if (!groups[drive.group]) groups[drive.group] = [];
                groups[drive.group].push(drive);
            });
            container.innerHTML = '';
            for (let group in groups) {
                let groupDiv = document.createElement("div");
                groupDiv.className = "group";
                let groupTitleContainer = document.createElement("div");
                groupTitleContainer.style.display = "flex";
                groupTitleContainer.style.alignItems = "center";
                let groupTitle = document.createElement("div");
                groupTitle.className = "group-title";
                groupTitle.style.width = "90%";
                let totalCfm = groups[group].reduce((sum, drive) => sum + (parseFloat(drive.actualCfm) || 0), 0);
                let avgPercent = 0;
                if (groups[group].length > 0) {
                    avgPercent = groups[group].reduce((sum, drive) => sum + (parseFloat(drive.actualPercent) || 0), 0) / groups[group].length;
                }
                groupTitle.innerHTML = `${groupLabel} ${group} &nbsp;>>&nbsp; Fan power <span class="status-box blue totalcfm">${totalCfm} CFM</span> <span class="status-box blue totalcfm">${avgPercent.toFixed(1)} %</span>`;
                groupTitle.addEventListener("click", function () {
                    const list = groupDiv.querySelector(".drive-list");
                    list.style.display = (list.style.display === "block") ? "none" : "block";
                    expandedGroups[group] = list.style.display === "block";
                    localStorage.setItem("expandedGroups", JSON.stringify(expandedGroups));
                });
                let quickButtons = document.createElement("div");
                quickButtons.style.display = "flex";
                quickButtons.style.alignItems = "center";
                quickButtons.innerHTML = `
                    <button class="quickbutton green" style="margin-left:8px;" onclick="quickGroupControl('${group}', 'Start')">Start</button>
                    <button class="quickbutton orange" style="margin-left:4px;" onclick="quickGroupControl('${group}', 'Stop')">Stop</button>
                `;
                let selectAllDiv = document.createElement("div");
                selectAllDiv.style.marginLeft = "10px";
                let selectAllChecked = groups[group].every(drive => currentCheckboxStates[drive.ip] === true);
                selectAllDiv.innerHTML = `<input type="checkbox" class="select-all" data-group="${group}" ${selectAllChecked ? 'checked' : ''}> Select All`;
                groupTitleContainer.appendChild(groupTitle);
                groupTitleContainer.appendChild(quickButtons);
                groupTitleContainer.appendChild(selectAllDiv);
                let driveList = document.createElement("div");
                driveList.className = "drive-list";
                driveList.style.display = expandedGroups[group] ? "block" : "none";
                groups[group].forEach(drive => {
                    let driveItem = document.createElement("div");
                    driveItem.className = "drive-item";

                    // Use the previously stored checkbox state
                    let checked = currentCheckboxStates[drive.ip] || false;

                    let lastUpdated = new Date(drive.lastUpdated * 1000);
                    let currentTime = new Date();
                    let timeDiff = (currentTime - lastUpdated) / 1000;

                    let countdown = '';
                    if (timeDiff > 30) {
                        countdown = ` (Not updated for ${Math.floor(timeDiff)} seconds)`;
                        driveItem.classList.add("stale-data");
                    } else {
                        countdown = ``;
                        driveItem.classList.remove("stale-data");
                    }

                    if (drive.status === 'Unknown') checked = false;

                    const statusText = drive.status === 'Unknown' ? 'Attempting Poll' :
                        drive.status === 'Waiting' ? 'Initialization' :
                        drive.status === 'Running' && drive.actualSpeed === 0 ? 'Fan Hold' :
                        drive.status === 'Stopped' ? 'Freespin' :
                        drive.status === 'NotReady' ? 'Not Ready / Inhibited' :
                        drive.status === 'Tripped' ? 'Tripped' :
                        drive.status === 'Unavailable' ? 'Unavailable' :
                        drive.status === 'Disabled' ? 'Disconnected' :
                        drive.status === 'Running' ? 'Running' : '';

                    const statusColor = drive.status === 'Stopped' ? '#FFA500' :
                        drive.status === 'Running' && drive.actualSpeed > 0 ? '#4CAF50' :
                        drive.status === 'NotReady' ? '#f44336' :
                        drive.status === 'Tripped' ? '#f44336' :
                        drive.status === 'Unavailable' ? '#f44336' :
                        drive.status === 'Freespin' ? '#f44336' :
                        drive.status === 'Disabled' ? '#555555' :
                        drive.status === 'Running' && drive.actualSpeed === 0 ? '#f44336' :
                        '#007bff';

                    driveItem.innerHTML = `
                        <input type="checkbox" class="drive-checkbox" data-ip="${drive.ip}" data-group="${group}" ${checked ? 'checked' : ''} ${drive.status === 'Unknown' ? 'disabled' : ''}>
                        <span style="flex:1;">
                            Fan #${drive.fanNumber} <span class="status-box inform">[${drive.fanDesc}]</span> ${drive.ip} >>
                            <span class="status-box grey" style="width: 60px; text-align: center;">${drive.setSpeed} Hz</span>
                            <span class="status-box blue" style="width: 60px; text-align: center;">${drive.actualSpeed} Hz</span>
                            <span class="status-box blue" style="width: 80px; text-align: center;">${drive.rpmSpeed} RPM</span>
                            <span class="status-box blue" style="width: 100px; text-align: center;">${drive.actualCfm} CFM</span>
                            <span class="status-box blue" style="width: 50px; text-align: center;">${drive.current} A</span>
                            <span class="status-box blue" style="width: 60px; text-align: center;">${drive.actualPercent} %</span>
                            <span class="status-box" style="background: ${statusColor}; color: white; text-align: center; padding: 4px; border-radius: 4px;">
                                ${statusText}${countdown}
                            </span>
                        </span>
                    `;
                    // Control button to enable/disable
                    let controlBtn = document.createElement('button');
                    controlBtn.className = 'status-box';
                    controlBtn.style.marginLeft = '8px';
                    controlBtn.style.fontSize = '12px';
                    controlBtn.style.cursor = 'pointer';
                    if (drive.status === 'Disabled') {
                        controlBtn.textContent = 'Connect';
                        controlBtn.style.backgroundColor = '#4CAF50';
                        controlBtn.onclick = function() {
                            controlBtn.disabled = true;
                            fetch('/vfdconnect', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ ip: drive.ip })
                            }); // Wait for WebSocket update
                        };
                    } else {
                        controlBtn.textContent = 'Disconnect';
                        controlBtn.style.backgroundColor = '#f44336';
                        controlBtn.onclick = function() {
                            controlBtn.disabled = true;
                            fetch('/vfdconnect', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ ip: drive.ip })
                            }); // Wait for WebSocket update
                        };
                    }
                    driveItem.appendChild(controlBtn);
                    driveList.appendChild(driveItem);
                });
                groupDiv.appendChild(groupTitleContainer);
                groupDiv.appendChild(driveList);
                container.appendChild(groupDiv);
            }
            document.querySelectorAll(".select-all").forEach(checkbox => {
                checkbox.addEventListener("change", function () {
                    let group = this.dataset.group;
                    let checkboxes = document.querySelectorAll(`.drive-checkbox[data-group='${group}']`);
                    checkboxes.forEach(cb => { if (!cb.disabled) { cb.checked = this.checked; } });
                });
            });
            document.querySelectorAll(".drive-checkbox").forEach(checkbox => {
                checkbox.addEventListener("change", function () {
                    let group = this.dataset.group;
                    let selectAllCheckbox = document.querySelector(`.select-all[data-group='${group}']`);
                    let allChecked = Array.from(document.querySelectorAll(`.drive-checkbox[data-group='${group}']`)).every(cb => !cb.disabled && cb.checked);
                    selectAllCheckbox.checked = allChecked;
                });
            });
        }
        function updateControlEvents() {
            fetch('/control-events')
                .then(response => response.json())
                .then(events => {
                    controlEvents = events;
                    updateControlEventsUI();
                });
        }
        function updateControlEventsUI() {
            const controlEventsDiv = document.getElementById('control-events');
            controlEventsDiv.innerHTML = '';
            controlEvents.slice().reverse().forEach(event => {
                const eventDiv = document.createElement('div');
                eventDiv.className = 'control-event';
                const timestamp = new Date(event.timestamp);
                const formattedDate = `${timestamp.getFullYear()}-${String(timestamp.getMonth() + 1).padStart(2, '0')}-${String(timestamp.getDate()).padStart(2, '0')} ${String(timestamp.getHours()).padStart(2, '0')}:${String(timestamp.getMinutes()).padStart(2, '0')}:${String(timestamp.getSeconds()).padStart(2, '0')}`;
                eventDiv.innerHTML = `
                    <div>
                        <span class="timestamp">${formattedDate}</span>
                        <span class="event-box" style="background-color: #007bff; color: white;">
                        ${event.action === 'SetSpeed' ? `Set ${event.speed} Hz` : event.action}</span>
                    </div>
                    ${event.drives.map(drive => `
                        <span class="devices-box" style="background-color: ${drive.success ? '#4CAF50' : '#f44336'}; color: white;">${drive.ip}${drive.error ? ` - ${drive.error}` : ''}</span>
                    `).join('')}
                `;
                controlEventsDiv.appendChild(eventDiv);
            });
        }

        // === 4. Control Functions ===
        function sendControl(action, speed = null) {
            if (action === 'SetSpeed' && (!speed || speed.trim() === '')) {
                alert('Please enter a speed value');
                return;
            }
            let selectedDrives = Array.from(document.querySelectorAll(".drive-checkbox:checked")).map(cb => cb.dataset.ip);
            if (selectedDrives.length === 0) return alert("No drives selected.");
            let body = { drives: selectedDrives, action: action };
            if (speed) body.speed = parseFloat(speed);
            fetch('/control', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            }).then(response => response.text())
        }
        function quickGroupControl(group, action) {
            let drives = Array.from(document.querySelectorAll(`.drive-checkbox[data-group='${group}']`)).map(cb => cb.dataset.ip);
            if (drives.length === 0) return alert("No drives in this group.");
            let body = { drives: drives, action: action };
            fetch('/control', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            }).then(response => response.text());
        }
        function selectAllDrives() {
            const selectAllCheckbox = document.getElementById('select-all');
            const checkboxes = document.querySelectorAll('.drive-checkbox');
            checkboxes.forEach(checkbox => { if (!checkbox.disabled) { checkbox.checked = selectAllCheckbox.checked; } });
        }

        // === 5. Event Listeners and Dark Mode ===
        document.addEventListener("DOMContentLoaded", function() {
            const hertzInput = document.getElementById('speed-value');
            const percentInput = document.getElementById('percent-value');
            hertzInput.addEventListener('input', function() {
                const hz = parseFloat(this.value) || 0;
                percentInput.value = ((hz / 60) * 100).toFixed(1);
            });
            percentInput.addEventListener('input', function() {
                const percent = parseFloat(this.value) || 0;
                hertzInput.value = ((percent / 100) * 60).toFixed(1);
            });
            // Dark mode toggle
            const darkModeToggle = document.getElementById('darkModeToggle');
            function setDarkMode(on) {
                if (on) {
                    document.body.classList.add('dark-mode');
                    darkModeToggle.textContent = '💡 Light Mode';
                } else {
                    document.body.classList.remove('dark-mode');
                    darkModeToggle.textContent = '🌙 Dark Mode';
                }
            }
            let darkPref = localStorage.getItem('darkMode') === 'true';
            setDarkMode(darkPref);
            darkModeToggle.onclick = function() {
                darkPref = !darkPref;
                localStorage.setItem('darkMode', darkPref);
                setDarkMode(darkPref);
            };
            document.getElementById('apiModalBtn').onclick = function() {
              document.getElementById('apiModal').style.display = 'block';
            };
        });
        setInterval(updateControlEvents, 1000);
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>VFD Control Panel</h1>
        </div>
        <div class="control-panel" style="display: flex; align-items: center; justify-content: space-between;">
            <div class="fan-buttons"><span class="control-button-title">Fan Controls</span><br>
                <input type="number" id="speed-value" step=".1" placeholder="Speed (Hz)" onkeydown="if(event.key==='Enter'){sendControl('SetSpeed', document.getElementById('speed-value').value);}" required> <span class="speed-legend">Hz</span>&nbsp;&nbsp;
                <input type="number" id="percent-value" step=".1" placeholder="Speed (%)" onkeydown="if(event.key==='Enter'){sendControl('SetSpeed', document.getElementById('speed-value').value);}" required> <span class="speed-legend">%</span>&nbsp;&nbsp;
                <button class="set-speed" tooltip="Sets VFD speed and starts it." onclick="sendControl('SetSpeed', document.getElementById('speed-value').value)">Set Speed</button>&nbsp;&nbsp; | &nbsp;&nbsp;
                <button class="start" tooltip="Starts the VFD using previously set speed." onclick="sendControl('Start')">Start</button>
                <button class="stop" tooltip="Stops the VFD." onclick="sendControl('Stop')">Stop</button>
                <button class="fanhold" tooltip="Sets the VFD speed at 0 and keeps the VFD to ON. This stops blades from spinning"onclick="sendControl('Fanhold')">Fan Hold (0 Hz)</button>
                <input type="checkbox" id="select-all" onclick="selectAllDrives()">Select All
            </div>
            <button id="darkModeToggle" style="padding: 8px 18px; border-radius: 6px; border: none; background: #23272a; color: #fff; font-size: 16px; cursor: pointer; margin-left: 20px;">🌙 Dark Mode</button>
        </div>
        <button id="apiModalBtn" style="position:fixed;bottom:24px;right:32px;z-index:1100;padding:8px 18px;border-radius:6px;border:none;background:#007bff;color:#fff;font-size:16px;box-shadow:0 4px 16px rgba(0,0,0,0.18);cursor:pointer;transition:background 0.2s;">🌍 Remote Control API</button>
        <div id="apiModal" class="modal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100vw; height:100vh; overflow:auto; background:rgba(0,0,0,0.5);">
          <div style="background:#fff; margin:5% auto; padding:30px 24px 24px 24px; border-radius:12px; max-width:600px; position:relative; box-shadow:0 4px 32px rgba(0,0,0,0.2); font-size:16px;">
            <button onclick="document.getElementById('apiModal').style.display='none'" style="position:absolute; top:12px; right:16px; background:none; border:none; font-size:28px; color:#333; cursor:pointer;">&times;</button>
            <h2 style="margin-top:0;">🌍 Remote Control API</h2>
            <div style="overflow-x:auto; max-width:100%;">
              <div style="margin-bottom:18px;">
                <b>Remotely control the VFD server by sending JSON commands to its HTTP endpoints.</b><br>
                All endpoints are accessible on <code>http://&lt;BindIP&gt;:80</code> (as set in your config).
              </div>
              <h3 style="margin-bottom:6px;">🖥️ <b>/devices</b> (GET)</h3>
              <div style="margin-bottom:8px;">Fetch a list of all drives, including their configuration (from config) and current live data (setpoint, speed, rpm, cfm, amps, status, etc.).</div>
              <div style="background:#f4f7fc; border-radius:8px; padding:10px; font-size:13px; margin-bottom:8px;"><code>curl http://10.33.10.53/devices</code></div>
              <div style="background:#f4f7fc; border-radius:8px; padding:10px; font-size:13px; margin-bottom:8px; overflow-x:auto;">
                <code>[<br>&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;"IP": "10.33.30.11",<br>&nbsp;&nbsp;&nbsp;&nbsp;"DriveType": "OptidriveE3",<br>&nbsp;&nbsp;&nbsp;&nbsp;"Group": 1,<br>&nbsp;&nbsp;&nbsp;&nbsp;"FanNumber": 1,<br>&nbsp;&nbsp;&nbsp;&nbsp;"FanDesc": "1x 1800RPM 29.5kCFM",<br>&nbsp;&nbsp;&nbsp;&nbsp;"RpmHz": 30,<br>&nbsp;&nbsp;&nbsp;&nbsp;"CfmRpm": 16.38888888,<br>&nbsp;&nbsp;&nbsp;&nbsp;"Port": 502,<br>&nbsp;&nbsp;&nbsp;&nbsp;"Unit": 1,<br>&nbsp;&nbsp;&nbsp;&nbsp;"setSpeed": 45.0,<br>&nbsp;&nbsp;&nbsp;&nbsp;"actualSpeed": 44.8,<br>&nbsp;&nbsp;&nbsp;&nbsp;"rpmSpeed": 1344,<br>&nbsp;&nbsp;&nbsp;&nbsp;"actualCfm": 22000,<br>&nbsp;&nbsp;&nbsp;&nbsp;"current": 8.2,<br>&nbsp;&nbsp;&nbsp;&nbsp;"status": "Running",<br>&nbsp;&nbsp;&nbsp;&nbsp;"lastUpdated": 1718030000<br>&nbsp;&nbsp;&nbsp;&nbsp;// ... other live fields ...<br>&nbsp;&nbsp;}<br>]</code>
              </div>
              <div style="margin-bottom:18px;">Returns an array of objects, each containing both static config and live data for every drive.</div>
              <h3 style="margin-bottom:6px;">🔗 <b>/control</b> (POST)</h3>
              <div style="margin-bottom:8px;">Remotely start, stop, set speed, or hold fans.<br>Accepts a JSON payload with the following elements:</div>
              <div style="background:#f4f7fc; border-radius:8px; padding:10px; font-size:14px; margin-bottom:8px;">
                <code>{<br>&nbsp;&nbsp;"drives": ["10.33.30.11", "10.33.30.12"],<br>&nbsp;&nbsp;"action": "SetSpeed",<br>&nbsp;&nbsp;"speed": 45.0<br>}</code>
              </div>
              <div style="margin-bottom:8px;">Query Elements:</div>
              <ul style="font-size:14px; margin-bottom:8px;">
                <li><b>drives</b>: Array of VFD IPs to control</li>
                <li><b>action</b>: Control action (see below)</li>
                <li><b>speed</b>: Frequency in Hz for SetSpeed action only (Optional)</li>
              </ul>
              </div>
              <div style="margin-bottom:8px;">Actions:</div>
              <ul style="font-size:14px; margin-bottom:8px;">
                <li>▶️ <b>Start</b>: Start the selected drives</li>
                <li>⏹️ <b>Stop</b>: Stop the selected drives</li>
                <li>🛑 <b>Fanhold</b>: Set speed to 0 Hz but keep drive enabled</li>
                <li>𖣘 <b>Freespin</b>: Alias for Stop (let fan coast)</li>
                <li>⏲ <b>SetSpeed</b>: Set the speed (Hz) and start the drive</li>
              </ul>
              <div style="margin-bottom:8px;">Example <b>curl</b> command:</div>
              <div style="background:#f4f7fc; border-radius:8px; padding:10px; font-size:13px; margin-bottom:8px;">
                <code>curl -X POST http://10.33.10.53/control \<br>  -H 'Content-Type: application/json' \<br>  -d '{"drives": ["10.33.30.11"], "action": "SetSpeed", "speed": 45.0}'</code>
              </div>
              <div style="margin-bottom:18px;">✅ <b>Success:</b> <code>200 OK</code> with message <i>Control action processed successfully</i> or error details</div>

              <h3 style="margin-bottom:6px;">📜 <b>/control-events</b> (GET)</h3>
              <div style="margin-bottom:8px;">Fetch a list of recent control events (for audit/logging).</div>
              <div style="background:#f4f7fc; border-radius:8px; padding:10px; font-size:13px; margin-bottom:8px;">
                <code>curl http://10.33.10.53/control-events</code>
              </div>
              <div style="background:#f4f7fc; border-radius:8px; padding:10px; font-size:13px; margin-bottom:8px; overflow-x:auto;">
                <code>[<br>&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;"timestamp": "2024-06-10T12:34:56Z",<br>&nbsp;&nbsp;&nbsp;&nbsp;"action": "SetSpeed",<br>&nbsp;&nbsp;&nbsp;&nbsp;"speed": 45.0,<br>&nbsp;&nbsp;&nbsp;&nbsp;"drives": [<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ "ip": "10.33.30.11", "success": true },<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ "ip": "10.33.30.12", "success": false, "error": "Tripped" }<br>&nbsp;&nbsp;&nbsp;&nbsp;]<br>&nbsp;&nbsp;}<br>]</code>
              </div>

              <h3 style="margin-bottom:6px;">🔌 <b>/vfdconnect</b> (POST)</h3>
              <div style="margin-bottom:8px;">Connect or disconnect a VFD by IP. Used by the UI to reconnect or disconnect a drive. This is merely a toggle, so invoking this does not specify whether to turn it on or off, it just change it's status.</div>
              <div style="background:#f4f7fc; border-radius:8px; padding:10px; font-size:13px; margin-bottom:8px;">
                <code>{ "ip": "10.33.30.11" }</code>
              </div>
              <div style="background:#f4f7fc; border-radius:8px; padding:10px; font-size:13px; margin-bottom:8px;">
                <code>curl -X POST http://10.33.10.53/vfdconnect \<br>  -H 'Content-Type: application/json' \<br>  -d '{"ip": "10.33.30.11"}'</code>
              </div>
            </div>
          </div>
        </div>
        <div class="drives-box">
            <div id="drive-container" class="drives-panel"></div>
            <div class="control-events-panel">
                <h2>Control Events</h2>
                <div id="control-events"></div>
            </div>
        </div>
    </div>
</body>
</html>
