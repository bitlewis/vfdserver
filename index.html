<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Doto:wght@400..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Doto:wght@100..900&display=swap" rel="stylesheet">
    <title>BLU01 VFD Control</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f7fc;}
        .container { position: relative; width: 100%; }
        .header { position: fixed; top: 0; left: 0; width: 100%; background-color: #f4f7fc; text-align: center; }
        h1 { text-align: center; color: #333; font-size: 42px; font-family:"Doto", serif; font-optical-sizing: auto; font-style: normal; font-weight: 700; }
        .group { margin-bottom: 10px; }
        .group-title-container { display: flex; align-items: center; }
        .group-title { width: 80%; cursor: pointer; font-size: 18px; font-family:"Doto", serif; font-optical-sizing: auto; font-style: normal; font-weight: 700; background: #4CAF50; color: white; border-radius: 5px; padding: 10px; }
        .drive-list { display: none; padding-left: 15px; }
        .drive-item { padding: 5px; background: #fff; margin: 5px 0; border-radius: 5px; display: flex; align-items: center; }
        input[type="checkbox"] { margin-right: 10px; }
        .select-all-container { margin-top: 10px; margin-bottom: 10px; font-size: 16px; }
        .status-box { padding: 4px; border-radius: 4px; display: inline-block; cursor: not-allowed; }
        .grey { background-color: #d3d3d3; color: #555; }
        .blue { background-color: #007bff; color: white; }
        .stale-data { background-color: #d3d3d3; }
        .control-panel { background-color: #fff; margin: 20px; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); position: fixed; top: 60px; width: 96.5%; }
        .control-panel button { font-size: 16px; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
        .control-panel button.freespin { background-color: #ffa500; color: white; }
        .control-panel button.fanhold { background-color: #f44336; color: white; }
        .control-panel button.set-speed { background-color: #128115; color: white; }
        .control-panel button.restart { background-color: #128115; color: white; }
        .control-panel button.stop { background-color: #f44336; color: white; }
        .control-panel input[type="number"] { padding: 10px; border: 1px solid #999999; border-radius: 5px; width: 100px; }
        .drives-box { padding-top: 180px; width: 100%; margin: 20px auto; width: 97%;}
        .drives-panel { float: left; width: 83%; padding-bottom: 20px; }
        .control-events-panel { float: right; width: 15%; background-color: #fff; padding: 20px; overflow-y: auto; border-radius: 5px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); }
        @media (max-width: 768px) { .control-events-panel { position: static; width: 100%; height: auto; border-left: none; border-top: 1px solid #ddd; } }
        .control-events-panel h2 { margin-top: 0; font-size: 25px; font-family:"Doto", serif; font-optical-sizing: auto; font-style: normal; font-weight: 700; }
        .control-event { padding: 10px; border-bottom: 1px solid #ddd; }
        .control-event:last-child { border-bottom: none; }
        .event-box { padding: 4px; border-radius: 4px; font-size: 12px; display: inline-block; cursor: not-allowed; }
        .devices-box { padding: 4px; border-radius: 4px; font-size: 10px; display: inline-block; cursor: not-allowed; }
        .timestamp { font-size: 14px; display:inline-block; border-bottom:2px solid black; margin-bottom: 2px; }
        .action-text { font-size: 12px; }
        .control-button-title { font-size: 20px; font-family:"Doto", serif; font-optical-sizing: auto; font-style: normal; font-weight: 700; margin-bottom: 10px; }
        .fan-buttons { float: left; }
        .speed-legend { font-size: 14px; font-family:"Doto", serif; font-optical-sizing: auto; font-style: normal; font-weight: 500; }
        .vfd-buttons { float: right; }
    </style>
    <script>
        let expandedGroups = JSON.parse(localStorage.getItem("expandedGroups")) || {};
        if (Object.keys(expandedGroups).length === 0) {
            expandedGroups = new Proxy({}, { get: () => true }); // Default all GROUPs to expanded
        }

        document.addEventListener("DOMContentLoaded", function() {
            const ws = new WebSocket('ws://10.32.10.53/ws');
            ws.onmessage = function (event) {
                const data = JSON.parse(event.data);
                updateUI(data);
            };
        });

        function updateUI(data) {
            const container = document.getElementById('drive-container');
            const currentCheckboxStates = {}; // Store the current checkbox states

            // Store the current checkbox states before updating the data
            document.querySelectorAll(".drive-checkbox").forEach(cb => {
                currentCheckboxStates[cb.dataset.ip] = cb.checked;
            });

            // Organize drives by GROUP
            let groups = {};
            data.forEach(drive => {
                if (!groups[drive.group]) {
                    groups[drive.group] = [];
                }
                groups[drive.group].push(drive);
            });

            container.innerHTML = '';  // Clear the container to update it

            // Create or update GROUPs
            for (let group in groups) {
                let groupDiv = document.createElement("div");
                groupDiv.className = "group";

                let groupTitleContainer = document.createElement("div");
                groupTitleContainer.style.display = "flex";
                groupTitleContainer.style.alignItems = "center";

                let groupTitle = document.createElement("div");
                groupTitle.className = "group-title";
                groupTitle.style.width = "92%"; // Reduce the width of the GROUP title
                groupTitle.innerHTML = `GROUP ${group}`;
                groupTitle.addEventListener("click", function () {
                    const list = groupDiv.querySelector(".drive-list");
                    list.style.display = (list.style.display === "block") ? "none" : "block";
                    expandedGroups[group] = list.style.display === "block";
                    localStorage.setItem("expandedGroups", JSON.stringify(expandedGroups));
                });

                let selectAllDiv = document.createElement("div");
                selectAllDiv.style.marginLeft = "10px";
                let selectAllChecked = groups[group].every(drive => currentCheckboxStates[drive.ip] === true); // Check if all drives are selected
                selectAllDiv.innerHTML = `<input type="checkbox" class="select-all" data-group="${group}" ${selectAllChecked ? 'checked' : ''}> Select All`;

                groupTitleContainer.appendChild(groupTitle);
                groupTitleContainer.appendChild(selectAllDiv);

                let driveList = document.createElement("div");
                driveList.className = "drive-list";
                driveList.style.display = expandedGroups[group] ? "block" : "none";

                groups[group].forEach(drive => {
                    let driveItem = document.createElement("div");
                    driveItem.className = "drive-item";

                    // Use the previously stored checkbox state
                    let checked = currentCheckboxStates[drive.ip] || false;

                    let lastUpdated = new Date(drive.lastUpdated * 1000);
                    let currentTime = new Date();
                    let timeDiff = (currentTime - lastUpdated) / 1000;

                    let countdown = '';
                    if (timeDiff > 15) {
                        countdown = ` (Not updated for ${Math.floor(timeDiff)} seconds)`;
                        driveItem.classList.add("stale-data");
                    } else {
                        countdown = ``;
                        driveItem.classList.remove("stale-data");
                    }

                    // Uncheck and disable the checkbox if the drive status is Unknown
                    if (drive.status === 'Unknown') {
                        checked = false;
                    }

                    const statusText = drive.status === 'Unknown' ? 'Attempting Poll' :
                        drive.status === 'Waiting' ? 'Initialization' :
                        drive.status === 'Stopped' ? 'Freespin' :
                        drive.status === 'Running' && drive.setSpeed === 0 ? 'Fan Hold' :
                        drive.status === 'Running' ? 'Running' : '';

                    const statusColor = drive.status === 'Stopped' ? '#FFA500' :
                        drive.status === 'Running' && drive.setSpeed > 0 ? '#4CAF50' :
                        drive.status === 'Running' && drive.setSpeed === 0 ? '#f44336' :
                        '#007bff';

                    driveItem.innerHTML = `
                        <input type="checkbox" class="drive-checkbox" data-ip="${drive.ip}" data-group="${group}" ${checked ? 'checked' : ''} ${drive.status === 'Unknown' ? 'disabled' : ''}>
                        <span>
                            Fan #${drive.fanNumber} - ${drive.fanDesc} - ${drive.ip} >>
                            <span class="status-box grey" style="width: 60px; text-align: center;">${drive.setSpeed} Hz</span>
                            <span class="status-box blue" style="width: 60px; text-align: center;">${drive.actualSpeed} Hz</span>
                            <span class="status-box blue" style="width: 80px; text-align: center;">${drive.rpmSpeed} RPM</span>
                            <span class="status-box blue" style="width: 100px; text-align: center;">${drive.actualCfm} CFM</span>
                            <span class="status-box blue" style="width: 50px; text-align: center;">${drive.current} A</span>
                            <span class="status-box blue" style="width: 60px; text-align: center;">${drive.actualPercent} %</span>
                            <span class="status-box" style="background: ${statusColor}; color: white; text-align: center; padding: 4px; border-radius: 4px;">
                                ${statusText}${countdown}
                            </span>
                        </span>
                    `;

                    driveList.appendChild(driveItem);
                });
                groupDiv.appendChild(groupTitleContainer);
                groupDiv.appendChild(driveList);
                container.appendChild(groupDiv);
            }

            // Reattach the 'Select All' checkbox functionality
            document.querySelectorAll(".select-all").forEach(checkbox => {
                checkbox.addEventListener("change", function () {
                    let group = this.dataset.group;
                    let checkboxes = document.querySelectorAll(`.drive-checkbox[data-group='${group}']`);
                    checkboxes.forEach(cb => {
                        if (!cb.disabled) {
                            cb.checked = this.checked;
                        }
                    });
                });
            });

            // Reattach the checkbox change event for individual drives
            document.querySelectorAll(".drive-checkbox").forEach(checkbox => {
                checkbox.addEventListener("change", function () {
                    let group = this.dataset.group;
                    let selectAllCheckbox = document.querySelector(`.select-all[data-group='${group}']`);
                    let allChecked = Array.from(document.querySelectorAll(`.drive-checkbox[data-group='${group}']`))
                        .every(cb => !cb.disabled && cb.checked);
                    selectAllCheckbox.checked = allChecked;
                });
            });
        }
        function selectAllDrives() {
            const selectAllCheckbox = document.getElementById('select-all');
            const checkboxes = document.querySelectorAll('.drive-checkbox');

            checkboxes.forEach(checkbox => {
                if (!checkbox.disabled) {
                    checkbox.checked = selectAllCheckbox.checked;
                }
            });

        }
        let controlEvents = [];


        function sendControl(action, speed = null) {
            if (action === 'SetSpeed' && (!speed || speed.trim() === '')) {
                alert('Please enter a speed value');
                return;
            }

            let selectedDrives = Array.from(document.querySelectorAll(".drive-checkbox:checked"))
                .map(cb => cb.dataset.ip);

            if (selectedDrives.length === 0) return alert("No drives selected.");

            let body = { drives: selectedDrives, action: action };
            if (speed) body.speed = parseFloat(speed);

            fetch('/control', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            }).then(response => response.text())
        }

        function updateControlEvents() {
            fetch('/control-events')
                .then(response => response.json())
                .then(events => {
                    controlEvents = events;
                    updateControlEventsUI();
                });
        }

        function updateControlEventsUI() {
            const controlEventsDiv = document.getElementById('control-events');
            controlEventsDiv.innerHTML = '';
            controlEvents.slice().reverse().forEach(event => {
                const eventDiv = document.createElement('div');
                eventDiv.className = 'control-event';

                // Format timestamp as YYYY-MM-DD HH-MM-SS
                const timestamp = new Date(event.timestamp);
                const formattedDate = `${timestamp.getFullYear()}-${String(timestamp.getMonth() + 1).padStart(2, '0')}-${String(timestamp.getDate()).padStart(2, '0')} ${String(timestamp.getHours()).padStart(2, '0')}:${String(timestamp.getMinutes()).padStart(2, '0')}:${String(timestamp.getSeconds()).padStart(2, '0')}`;

                eventDiv.innerHTML = `
                    <div>
                        <span class="timestamp">${formattedDate}</span>
                        <span class="event-box" style="background-color: #007bff; color: white;">
                        ${event.action === 'SetSpeed' ? `Set ${event.speed} Hz (${event.speed * 30} RPM)` : event.action}</span>
                    </div>
                    ${event.drives.map(drive => `
                        <span class="devices-box" style="background-color: ${drive.success ? '#4CAF50' : '#f44336'}; color: white;">${drive.ip}${drive.error ? ` - ${drive.error}` : ''}</span>
                    `).join('')}
                `;
                controlEventsDiv.appendChild(eventDiv);
            });
        }

        document.addEventListener("DOMContentLoaded", function() {
            const hertzInput = document.getElementById('speed-value');
            const percentInput = document.getElementById('percent-value');

            hertzInput.addEventListener('input', function() {
                const hz = parseFloat(this.value) || 0;
                percentInput.value = ((hz / 60) * 100).toFixed(1);
            });

            percentInput.addEventListener('input', function() {
                const percent = parseFloat(this.value) || 0;
                hertzInput.value = ((percent / 100) * 60).toFixed(1);
            });

            setInterval(function() {
                const hzValue = parseFloat(document.getElementById('speed-value').value);
                const percentValue = (hzValue / 60) * 100;
                document.getElementById('percent-value').value = percentValue.toFixed(1);
            }, 1000);

            setInterval(function() {
                const percentValue = parseFloat(document.getElementById('percent-value').value);
                const hzValue = (percentValue / 100) * 60;
                document.getElementById('speed-value').value = hzValue.toFixed(1);
            }, 1000);
        });

        setInterval(updateControlEvents, 1000);
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>BLU01 VFD Control Panel</h1>
        </div>
        <div class="control-panel">
            <div class="fan-buttons"><span class="control-button-title">Fan Controls</span><br>
                <input type="number" id="speed-value" step=".1" placeholder="Speed (Hz)" required> <span class="speed-legend">Hz</span>&nbsp;&nbsp;
                <input type="number" id="percent-value" step=".1" placeholder="Speed (%)" required> <span class="speed-legend">%</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                <button class="set-speed" onclick="sendControl('SetSpeed', document.getElementById('speed-value').value)">Set Speed</button>
                <button class="freespin" onclick="sendControl('Freespin')">Freespin (Off)</button>
                <button class="fanhold" onclick="sendControl('Fanhold')">Fan Hold (0 Hz)</button>
                <input type="checkbox" id="select-all" onclick="selectAllDrives()">Select All
            </div>
            <div class="vfd-buttons"><span class="control-button-title">VFD Controls</span><br>
                <button class="restart" onclick="sendControl('Restart')">Start</button>
                <button class="stop" onclick="sendControl('Stop')">Stop</button>

            </div>
        </div>
        <div class="drives-box">
            <div id="drive-container" class="drives-panel"></div>
            <div class="control-events-panel">
                <h2>Control Events</h2>
                <div id="control-events"></div>
            </div>
        </div>
    </div>
</body>
</html>
